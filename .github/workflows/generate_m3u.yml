name: Δημιουργία M3U και αντιγραφή M3U στο δημόσιο αποθετήριο
# Δημιουργία M3U και αντιγραφή M3U στο δημόσιο αποθετήριο
on:
  schedule:
    - cron: "0 * * * *"  # Εκτέλεση κάθε ώρα στις :00 
    - cron: "30 * * * *"  # Εκτέλεση κάθε μισή ώρα στις :30
  workflow_dispatch: # Επιτρέπει την εκτέλεση του workflow χειροκίνητα από το GitHub UI

jobs:
  check-minutes:
    runs-on: ubuntu-latest
    steps:
      - name: Check remaining minutes
        id: check-minutes
        run: |
          remaining_minutes=$(gh api /rate_limit | jq .rate.remaining)
          echo "Remaining minutes: $remaining_minutes"
          if [ "$remaining_minutes" -lt 2000 ]; then
            echo "::set-output name=switch_profile::true"
          else
            echo "::set-output name=switch_profile::false"
          fi

  generate-m3u:
    runs-on: ubuntu-latest
    needs: check-minutes
    if: needs.check-minutes.outputs.switch_profile == 'false'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Πακέτα cache python
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Ρύθμιση Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12' # Χρησιμοποίησε την έκδοση Python που χρειάζεται το σκριπτ σου

      - name: Εγκατάσταση εξαρτήσεων
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Εκτέλεση σενάριου generate_m3u.py
        run: |
          python generate_m3u.py

      - name: Εμφάνιση περιεχομένων τρέχοντος καταλόγου
        run: |
         ls -la

      - name: Δέσμευση και προώθηση των αλλαγών στο δημόσιο αποθετήριο
        run: |
          git clone https://github.com/Blueddo2/Bluelist.git public_repo
          cp tiktok_live.m3u public_repo/tiktok_live.m3u
          cd public_repo
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add tiktok_live.m3u
          git commit -m 'Update M3U playlist'
          git push https://Blueddo:${{ secrets.PUBLIC_REPO_PAT }}@github.com/Blueddo2/Bluelist.git
        env:
          PUBLIC_REPO_PAT: ${{ secrets.PUBLIC_REPO_PAT }}

  generate-m3u-alt:
    runs-on: ubuntu-latest
    needs: check-minutes
    if: needs.check-minutes.outputs.switch_profile == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Πακέτα cache python
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Ρύθμιση Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12'

      - name: Εγκατάσταση εξαρτήσεων
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Εκτέλεση σενάριου generate_m3u.py
        run: |
          python generate_m3u.py

      - name: Εμφάνιση περιεχομένων τρέχοντος καταλόγου
        run: |
         ls -la

      - name: Δέσμευση και προώθηση των αλλαγών στο δημόσιο αποθετήριο
        run: |
          git clone https://github.com/Blueddo/Bluelist.git public_repo
          cp tiktok_live.m3u public_repo/tiktok_live.m3u
          cd public_repo
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add tiktok_live.m3u
          git commit -m 'Update M3U playlist'
          git push https://Blueddo:${{ secrets.PUBLIC_REPO_PAT_ALT }}@github.com/Blueddo/Bluelist.git
        env:
          PUBLIC_REPO_PAT_ALT: ${{ secrets.PUBLIC_REPO_PAT_ALT }}
